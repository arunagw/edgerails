<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Edge Rails.info :: Simpler Conditional Get Support (ETags)</title>
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <link href="/atom.xml" rel="alternate" title="Edge Rails.info" type="application/atom+xml" />
    <script type="text/javascript">
      //<![CDATA[
        var twitter_user = ""
        var show_replies = false;
        var tweet_count = 3;
      //]]>
    </script>
    <script src="http://ajax.googleapis.com/ajax/libs/mootools/1.2.4/mootools-yui-compressed.js" type="text/javascript"></script>
    <script src="/javascripts/mootools-1.2.4.2-more.js" type="text/javascript"></script>
    <script src="/javascripts/octopress.js" type="text/javascript"></script>
    <script src="/javascripts/twitter.js" type="text/javascript"></script>
  </head>
  <body id="">
    <div id="header">
      <div class="page_width">
        <a class="title" href="/">Edge Rails.info</a>
        <div id="search">
          <form action="http://www.google.com/cse" id="cse-search-box">
            <input name="cx" type="hidden" value="" />
            <input name="ie" type="hidden" value="UTF-8" />
            <input id="q" name="q" type="text" />
          </form>
        </div>
      </div>
    </div>
    <div id="nav">
      <div class="page_width">
        <ul>
          <li class="alpha">
            <a href="/">Blog</a>
          </li>
          <li class="omega">
            <a href="/about.html">About</a>
          </li>
          <li class="subscribe">
            <a href="/atom.xml">Subscribe</a>
          </li>
        </ul>
      </div>
    </div>
    <div id="page">
      <div class="page_width">
        <div id="main">
          <div class="blog">
            <div class="article">
              <h2>Simpler Conditional Get Support (ETags)</h2>
              &#x000A;<p><strong>Note:</strong> <em>This feature has been greatly improved since the writing of this article.  <a href="/articles/2008/10/25/what-s-new-in-edge-rails-even-better-conditional-get-support">See here</a> for the latest and greatest.</em></p>&#x000A;<p>Conditional-gets are a facility of the <span class="caps">HTTP</span> spec that provide a way for web servers to tell browsers that the response to a <code>GET</code> request hasn&#8217;t changed since the last request and can be safely pulled from the browser cache.</p>&#x000A;<p>They work by using the @ HTTP_IF_NONE_MATCH@ and @ HTTP_IF_MODIFIED_SINCE@ headers to pass back and forth both a unique content identifier and the timestamp of when the content was last changed.  If the browser makes a request where the content identifier (etag) or last modified since timestamp matches the server&#8217;s version then the server only needs to send back an empty response with a not modified status.</p>&#x000A;<p>It is the server&#8217;s (i.e. our) responsibility to look for a last modified timestamp and the if-none-match header and determine whether or not to send back the full response.  With <a href="http://github.com/JackDanger/rails/commit/b7529ed1cc7cfd8df5fd1b069e2881d39d3d984c">this new conditional-get support in rails</a> this is a pretty easy task:</p>&#x000A;<div class="highlight"><pre><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>&#x000A;&#x000A;  <span class="k">def</span> <span class="nf">show</span>&#x000A;    <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>&#x000A;&#x000A;    <span class="c1"># Set the response headers to accurately reflect the state of the</span>&#x000A;    <span class="c1"># requested object(s)</span>&#x000A;    <span class="n">response</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="vi">@article</span><span class="o">.</span><span class="n">published_at</span><span class="o">.</span><span class="n">utc</span>&#x000A;    <span class="n">response</span><span class="o">.</span><span class="n">etag</span> <span class="o">=</span> <span class="vi">@article</span>&#x000A;&#x000A;    <span class="c1"># If the request&#39;s state is the same as the server&#39;s state then we know</span>&#x000A;    <span class="c1"># we don&#39;t have to send back the whole body</span>&#x000A;    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">fresh?</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>&#x000A;      <span class="n">head</span> <span class="ss">:not_modified</span>&#x000A;    <span class="k">else</span>&#x000A;      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="n">wants</span><span class="o">|</span>&#x000A;        <span class="c1"># normal response processing</span>&#x000A;      <span class="k">end</span>&#x000A;    <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</pre>&#x000A;</div>&#x000A;<p>The etag value is calculated for you with the <code>etag=</code> setter method.  All you have to do is provide a single object or array of objects that uniquely identify this request.  In this example the article itself contains all the information that uniquely identifies the state of this request.  However, you may need to use more than one key in your app.  For instance, if the request is user specific:</p>&#x000A;<div class="highlight"><pre><span class="n">response</span><span class="o">.</span><span class="n">etag</span> <span class="o">=</span> <span class="o">[</span><span class="vi">@article</span><span class="p">,</span> <span class="n">current_user</span><span class="o">]</span>&#x000A;</pre>&#x000A;</div>&#x000A;<p>The <code>request.fresh?(response)</code> method is what will then tell you if the incoming request matches either the last-modified-since or if-none-match values of the outgoing response.  If it does you can avoid passing the full body of the response back and save some bandwidth.</p>&#x000A;<p>It&#8217;s also possible that you can avoid hitting the database all together if your application deals with completely static resources (though this is rare):</p>&#x000A;<div class="highlight"><pre><span class="k">class</span> <span class="nc">ArticlesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>&#x000A;&#x000A;  <span class="k">def</span> <span class="nf">show</span>&#x000A;&#x000A;    <span class="c1"># If articles don&#39;t change, the etag can be based solely</span>&#x000A;    <span class="c1"># on items we have in the request</span>&#x000A;    <span class="n">response</span><span class="o">.</span><span class="n">etag</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:article</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]]</span>&#x000A;&#x000A;    <span class="c1"># If the request&#39;s state is the same as the server&#39;s state then we can</span>&#x000A;    <span class="c1"># avoid the db call all together</span>&#x000A;    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">fresh?</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>&#x000A;      <span class="n">head</span> <span class="ss">:not_modified</span>&#x000A;    <span class="k">else</span>&#x000A;      <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>&#x000A;      <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="n">wants</span><span class="o">|</span>&#x000A;        <span class="o">.</span><span class="n">.</span><span class="o">.</span>&#x000A;      <span class="k">end</span>&#x000A;    <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</pre>&#x000A;</div>&#x000A;<p>So be a good citizen and make your requests conditional-get compatible.  It&#8217;s the right thing to do &#8211; and can make your apps more performant.</p>
            </div>
            <p class="pubdate">
              Published:
              14 Aug, 2008
            </p>
            <p class="related_articles">
              <h2>Related Articles</h2>
              <ul></ul>
              <li>
                <a href="/articles/what-s-new-in-edge-rails/2009/08/10/what-s-new-in-edge-rails-default-restful-rendering">Default RESTful Rendering</a>
              </li>
              <li>
                <a href="/articles/what-s-new-in-edge-rails/2009/02/01/what-s-new-in-edge-rails-nested-attributes">Nested Object Forms</a>
              </li>
              <li>
                <a href="/articles/what-s-new-in-edge-rails/2007/04/26/what-s-new-in-edge-rails-activeresource-gets-custom-methods">ActiveResource Gets Custom Methods</a>
              </li>
            </p>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
              //<![CDATA[
                var disqus_url = "http://rwdaigle.github.com/edgerails/articles/what-s-new-in-edge-rails/2008/08/14/what-s-new-in-edge-rails-simpler-conditional-get-support-etags";
              //]]>
            </script>
            <noscript>
              <a href="http://edgerails.disqus.com/?url=ref">View the discussion thread</a>
            </noscript>
            <script src="http://disqus.com/forums/edgerails/embed.js" type="text/javascript"></script>
          </div>
        </div>
        <div id="sidebar">
          <h4>Twitter <a class="small" href="http://twitter.com/">@</a></h4>
          <div id="twitter">
            <ul id="twitter_status">
              Status updating...
            </ul>
          </div>
          <h4>My Delicious <a class="small" href="http://delicious.com/">more &rarr;</a></h4>
          <div id="delicious">
            <script src="http://feeds.delicious.com/v2/js/?title=&amp;count=3&amp;sort=date&amp;extended" type="text/javascript"></script>
          </div>
        </div>
      </div>
    </div>
    <div id="footer">
      <div class="page_width">
        Copyright &copy; 2009 - Edge Rails.info -
        <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
      </div>
    </div>
    <!-- /Disqus Comments code -->
    <script type="text/javascript">
      //<![CDATA[
        (function() {
            var links = document.getElementsByTagName('a');
            var query = '?';
            for(var i = 0; i < links.length; i++) {
              if(links[i].href.indexOf('#disqus_thread') >= 0) {
                query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
              }
            }
            document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/edgerails/get_num_replies.js' + query + '"></' + 'script>');
          })();
      //]]>
    </script>
    <!-- /Google Analytics code -->
    <script type="text/javascript">
      //<![CDATA[
        try {
        var pageTracker = _gat._getTracker("");
        pageTracker._trackPageview();
        } catch(err) {}
      //]]>
    </script>
  </body>
</html>
